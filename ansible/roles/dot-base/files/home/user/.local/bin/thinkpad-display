#!/bin/bash

#
# See also: https://gist.github.com/seanf/e3be5bf745395d50e975
#

export DISPLAY=:0
export USER=psurya
export XAUTHORITY=/home/$USER/.Xauthority

function add_new_mode {
	#
	# The new mode was generated by the command:
	#
	#     $ cvt 3440 1440 30
	#
	# It seems as though the Lenovo T440s only supports 3440x1440
	# resolution if using a 30 Hz refresh rate, so I need to create
	# a new xrandr mode to use a resolution of 3440x1440 but at a
	# refresh rate of 30 Hz (there wasn't an existing mode).
	#
	/usr/bin/su $USER -c /bin/bash <<-EOF
		/usr/bin/xrandr --newmode "3440x1440_30.00" \
			196.25 3440 3600 3952 4464 1440 1443 1453 1468 \
			-hsync +vsync
		/usr/bin/xrandr --addmode $1 "3440x1440_30.00"
	EOF
}

function enable_internal {
	/usr/bin/su $USER -c /bin/bash <<-EOF
		/usr/bin/xrandr \
			--output DP-1   --off \
			--output DP-2   --off \
			--output HDMI-1 --off \
			--output HDMI-2 --off \
			--output DP-2-1 --off \
			--output DP-2-2 --off \
			--output DP-2-3 --off \
			--output eDP-1  --mode "1920x1080"
	EOF
}

function enable_external {
	add_new_mode "DP-2-1"
	/usr/bin/su $USER -c /bin/bash <<-EOF
		/usr/bin/xrandr \
			--output DP-1   --off \
			--output DP-2   --off \
			--output HDMI-1 --off \
			--output HDMI-2 --off \
			--output DP-2-1 --mode "3440x1440_30.00" \
			--output DP-2-2 --off \
			--output DP-2-3 --off \
			--output eDP-1  --off
	EOF
}

function usage {
	/usr/bin/cat <<-EOF
	$(basename $0) [-ehi]

	  This script is used to enable and disable the laptop's displays.
	  Either the "internal" or the "external" display can be enabled
	  at any given time; when one is enabled, the other is disabled.

	    -e  Enable the "external" display only.
	    -h  Print this help message.
	    -i  Enable the "internal" display only.
	EOF
}

while getopts "ehi" OPT; do
	case $OPT in
	e)
		sleep 1
		enable_external
		exit $?
		;;
	h)
		;;
	i)
		sleep 1
		enable_internal
		exit $?
		;;
	esac
done

usage
exit 1
